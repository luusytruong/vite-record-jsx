const L=(...e)=>console.log("%cR%cE%cC%cO%cR%cD","color: #03FFFF; font-weight: bold;","color: #56FFAA; font-weight: bold;","color: #AAFF55; font-weight: bold;","color: #FFFF00; font-weight: bold;","color: #FF8080; font-weight: bold;","color: #FF00FF; font-weight: bold;",...e),l=(e,t=document)=>t.querySelector(e),x=(e,t=document)=>Array.from(t.querySelectorAll(e)),y=e=>e.normalize("NFKC").replace(/\s+/g," ").trim(),M=e=>e?.match(/\d+/)?e.match(/\d+/)[0]:"0",A=e=>e&&!e.startsWith("Kéo và thả"),p=e=>y(e?.innerText||"");function S({el:e,question:t,restore:n,isRadio:r=!1,parentQuestion:c=null}){const o=x(".mdc-form-field",e),i=[],a=n?.find(s=>y(s?.text)===t.text&&s?.type===t.type)?.options||[],b=E(async()=>await F(c||t));for(const s of o){const d=l("input",s),g=l("label",s),u=l("img",s),f={is_correct:d?.checked||!1},w=p(g);w&&(f.text=w),u?.src&&(f.img_src=u.src),d?.addEventListener("change",()=>{r&&i.forEach(_=>_.is_correct=!1),f.is_correct=d.checked,b()});const m=a.find(_=>y(_.text)===w);m&&m.is_correct&&(d.checked=!0,f.is_correct=d.checked,d.dispatchEvent(new Event("change",{bubbles:!0}))),i.push(f)}t.options=i}function T(e,t,n,r,c=!1){const o=x(":scope > :nth-child(2) > div",e),i=x(":scope > div .cdk-drag",e),h=new Set(t.candidates),a=E(async()=>await F(t));i.forEach(s=>{const d=p(s);h.has(d)||(t.candidates.push(d),h.add(d))});const b=r?.find(s=>y(s?.text)===t.text);o.forEach(s=>{const d=p(l("h4",s)),g=l(":scope > div",s),u={text:d.replace(/^\d+\)\s*/,""),...c?{answers:[]}:{answer:""}},f=()=>{if(c)u.answers=Array.from(g.children).map(p).filter(A);else{const v=p(g);u.answer=A(v)?v:""}};f(),t.drag_map.push(u);const w=C(()=>{const v=c?u.answers.join(","):u.answer;f();const I=c?u.answers.join(","):u.answer;v!==I&&a()});w.observe(g,{childList:!0,subtree:c}),n.push(w);const m=b?.drag_map?.find(v=>v.text===u.text);if(!m)return;const _=(m.answers||[m.answer]).join(", "),Q=l(":scope >p",g);Q&&(Q.innerText=_)})}function R(e){["sub_questions","input_answers","candidates","drag_map","img_src","options","text"].forEach(n=>{e?.[n]?.length||delete e[n]})}const k=[];async function F(e){k[e.no-1]=e;const t=await D("test",k);L(t?"Saved":"Failed")}function C(e){return new MutationObserver(e)}function E(e,t=5e3){let n;return(...r)=>{clearTimeout(n),n=setTimeout(()=>e(...r),t)}}async function D(e,t){if(!chrome?.storage?.local)return!1;try{return await chrome.storage.local.set({[e]:t}),!0}catch{return!1}}async function $(e){if(chrome?.storage?.local)try{return(await chrome.storage.local.get(e))[e]}catch{return null}}function j(){return{no:M(p(l("fieldset legend"))),text:p(l("fieldset div")),img_src:l("fieldset img")?.src||"",sub_questions:[],input_answers:[],candidates:[],drag_map:[],options:[]}}function G(e){const t=p(l(":scope > label",e));return{no:M(p(l(":scope > label > b",e))),text:t.replace(/^\d+\)\s*/,"")}}function K(){const e=["radio","group-radio","check-box","grouping-2","drag-drop-2","group-input"];for(const t of e){const n=l(`question-type-${t}`);if(n)return{type:t,el:n}}return{type:"unknown",el:null}}function O({el:e,question:t,restore:n}){S({el:e,question:t,restore:n,isRadio:!0})}function z({el:e,question:t,restore:n}){const r=x(".question-type-group-radio__element",e),c=n?.filter(o=>o?.type==="group-radio"&&Array.isArray(o.sub_questions)).flatMap(o=>o.sub_questions)||[];for(const o of r){const i=G(o);S({el:o,question:i,isRadio:!0,parentQuestion:t,restore:c}),t.sub_questions.push(i)}}function B({el:e,question:t,restore:n}){S({el:e,question:t,restore:n})}function N({el:e,question:t,obsManager:n,restore:r}){T(e,t,n,r,!0)}function Z({el:e,question:t,obsManager:n,restore:r}){T(e,t,n,r,!1)}function P({el:e,question:t,restore:n}){const r=x("label",e),c=x("input",e),o=E(async()=>await F(t)),h=n?.find(a=>y(a?.text)===t.text&&a?.type===t.type)?.input_answers||[];r?.forEach((a,b)=>{const s=c[b],d=p(a).replace(/^\d+\)\s*/,""),g={text:d,value:s?.value||""};t.input_answers.push(g),s?.addEventListener("input",()=>{g.value=s.value,o()});const u=h.find(f=>y(f?.text)===d);u?.value&&(s.value=u.value,s.dispatchEvent(new Event("input",{bubbles:!0})))})}const W={radio:(...e)=>O(...e),"group-radio":(...e)=>z(...e),"check-box":(...e)=>B(...e),"grouping-2":(...e)=>N(...e),"drag-drop-2":(...e)=>Z(...e),"group-input":(...e)=>P(...e)};(()=>{if(!(location.hostname==="lms.ictu.edu.vn"||location.protocol==="file:"))return;console.clear();const t={lastIdx:0,obsManager:[],active:!0},n=l(".app-version");document.addEventListener("keydown",({ctrlKey:c,code:o})=>{if(o==="Backslash"&&(t.active=!t.active,t.active&&r(!1),n?.classList?.toggle("off",!t.active)),c&&o==="KeyC"){const i=getSelection()?.toString();i&&navigator.clipboard.writeText(i).catch(console.error)}}),window.addEventListener("contextmenu",c=>c.stopPropagation(),!0);const r=async(c=!0)=>{const{type:o,el:i}=K();if(!i)return;const h=t.active?await $("restore"):[],a=j();c&&t.lastIdx===a.no||(t.lastIdx=a.no,t.obsManager.forEach(b=>b.disconnect()),t.obsManager=[],a.type=o,W[o]?.({el:i,question:a,restore:h,...t}),R(a),L(a),await F(a))};n?.addEventListener("click",()=>{r(!1)}),setInterval(()=>r(),1e3),r()})();
