const S=(...e)=>console.log("%cR%cE%cC%cO%cR%cD","color: #03FFFF; font-weight: bold;","color: #56FFAA; font-weight: bold;","color: #AAFF55; font-weight: bold;","color: #FFFF00; font-weight: bold;","color: #FF8080; font-weight: bold;","color: #FF00FF; font-weight: bold;",...e),l=(e,t=document)=>t.querySelector(e),x=(e,t=document)=>Array.from(t.querySelectorAll(e)),_=e=>e.normalize("NFKC").replace(/\s+/g," ").trim(),C=e=>e?.match(/\d+/)?e.match(/\d+/)[0]:"0",Q=e=>e&&!e.startsWith("Kéo và thả"),b=e=>_(e?.innerText||"");async function k({el:e,question:t,restore:n,isRadio:s=!1,parentQuestion:c=null,multiple:a=!1}){const i=x(a?"mat-radio-button":".mdc-form-field",e),h=[],d=n?.find(r=>_(r?.text)===t.text&&r?.type===t.type)?.options||[],o=A(async()=>await L(c||t));for(const r of i){const g=l("input",r),u=l("label",r),v=l("img",r),m={is_correct:g?.checked||!1},w=b(u).replace(/^[*]?[A-Z]\.\s*/,"");w&&(m.text=w),v?.src&&(m.img_src=v.src);const y=()=>{s&&h.forEach(F=>F.is_correct=!1),m.is_correct=g.checked,r.classList.remove("vite-record"),o()};g?.addEventListener("change",y);const p=d.find(F=>_(F.text)===w);p&&p.is_correct&&!g.checked?r.classList.add("vite-record"):r.classList.remove("vite-record"),h.push(m)}t.options=h}function I(e,t,n,s,c=!1){const a=x(":scope > :nth-child(2) > div",e),i=x(":scope > div .cdk-drag",e),h=new Set(t.candidates),f=A(async()=>await L(t));i.forEach(o=>{const r=b(o);h.has(r)||(t.candidates.push(r),h.add(r))});const d=s?.find(o=>_(o?.text)===t.text);a.forEach(o=>{const r=b(l("h4",o)),g=l(":scope > div",o),u={text:r.replace(/^\d+\)\s*/,""),...c?{answers:[]}:{answer:""}},v=()=>{if(c)u.answers=Array.from(g.children).map(b).filter(Q);else{const p=b(g);u.answer=Q(p)?p:""}};v(),t.drag_map.push(u);const m=K(()=>{const p=c?u.answers.join(","):u.answer;v();const F=c?u.answers.join(","):u.answer;p!==F&&f()});m.observe(g,{childList:!0,subtree:c}),n.push(m);const w=d?.drag_map?.find(p=>p.text===u.text),y=l(":scope >p",g);if(w&&y){const p=w.answers||[w.answer];y.innerText=p.join(", ")}else!w&&y&&(y.innerText="Kéo và thả đáp án vào đây")})}function D(e){["sub_questions","input_answers","candidates","drag_map","img_src","options","is_new","text"].forEach(n=>{e?.[n]?.length||delete e[n]})}const M=[];async function L(e){M[e.no-1]=e;const t=await E("test",M);S(t?"Saved":"Failed")}function K(e){return new MutationObserver(e)}function A(e,t=400){let n;return(...s)=>{clearTimeout(n),n=setTimeout(()=>e(...s),t)}}async function E(e,t){if(!chrome?.storage?.local)return!1;try{return await chrome.storage.local.set({[e]:t}),!0}catch{return!1}}async function T(e){if(chrome?.storage?.local)try{return(await chrome.storage.local.get(e))[e]}catch{return null}}function $(e,t,n,s){document.addEventListener("keydown",async({ctrlKey:c,code:a})=>{if(c&&a==="KeyC"){const i=getSelection()?.toString();i&&navigator.clipboard.writeText(i).catch(console.error)}a==="ShiftRight"&&(e.active=!e.active,n(!1),await E("settings",{...t,toggle:e.active}).then(i=>S(i&&e.active?"on":"off")),s?.classList?.toggle("on",e.active)),a==="Slash"&&(e.mode=e.mode==="cursor"?"color":"cursor",document.body.classList.toggle("cursor",e.mode==="cursor"),await E("settings",{...t,mode:e.mode}).then(i=>S(i?"mode changed":"mode not changed")))}),window.addEventListener("contextmenu",c=>c.stopPropagation(),!0)}function j(){return{is_new:l("#mat-mdc-checkbox-4-input")?.checked||!1,no:C(b(l("fieldset legend"))),text:b(l("fieldset div")),img_src:l("fieldset img")?.src||"",sub_questions:[],input_answers:[],candidates:[],drag_map:[],options:[]}}function G(e){const t=b(l(":scope > label",e));return{no:C(b(l(":scope > label > b",e))),text:t.replace(/^\d+\)\s*/,"")}}function O(){const e=["radio","group-radio","check-box","grouping-2","drag-drop-2","group-input"];for(const t of e){const n=l(`question-type-${t}`);if(n)return{type:t,el:n}}return{type:"unknown",el:null}}function Z({el:e,question:t,restore:n}){k({el:e,question:t,restore:n,isRadio:!0})}async function z({el:e,question:t,restore:n}){const s=x(".question-type-group-radio__element",e),c=n?.filter(a=>a?.type==="group-radio"&&Array.isArray(a.sub_questions)).flatMap(a=>a.sub_questions)||[];for(const a of s){const i=G(a);k({el:a,question:i,isRadio:!0,parentQuestion:t,restore:c,multiple:!0}),t.sub_questions.push(i)}}function N({el:e,question:t,restore:n}){k({el:e,question:t,restore:n})}function W({el:e,question:t,obsManager:n,restore:s}){I(e,t,n,s,!0)}function B({el:e,question:t,obsManager:n,restore:s}){I(e,t,n,s,!1)}const R=new WeakMap;async function P({el:e,question:t,restore:n}){const s=x("label",e),c=x("input",e),a=A(async()=>await L(t)),h=n?.find(f=>_(f?.text)===t.text&&f?.type===t.type)?.input_answers||[];for(let f=0;f<s.length;f++){const d=s[f],o=c[f],r=b(d).replace(/^\d+\)\s*/,""),g={text:r,value:o?.value||""};t.input_answers.push(g),o?.addEventListener("input",()=>{g.value=o.value,a()});const u=h.find(w=>_(w?.text)===r),v=async()=>{u?.value&&(await navigator.clipboard.writeText(u.value),o.placeholder=u.value)},m=R.get(o);m&&o?.removeEventListener("focus",m),o?.addEventListener("focus",v),R.set(o,v),o?.addEventListener("blur",()=>o.placeholder="")}}const H={radio:(...e)=>Z(...e),"group-radio":(...e)=>z(...e),"check-box":(...e)=>N(...e),"grouping-2":(...e)=>W(...e),"drag-drop-2":(...e)=>B(...e),"group-input":(...e)=>P(...e)};(async()=>{if(!(location.hostname==="lms.ictu.edu.vn"||location.protocol==="file:"))return;console.clear();const t={lastIdx:0,obsManager:[],active:!0,mode:"cursor"},n=l(".app-version"),s=await T("settings");t.active=s?.toggle!==!1,t.mode=s?.mode||"cursor",document.body.classList.toggle("cursor",t.mode==="cursor"),n?.classList?.toggle("on",t.active);const c=async(a=!0)=>{const{type:i,el:h}=O();if(!h)return;const f=t.active?await T("restore"):[],d=j(),o=l("#mat-mdc-checkbox-4-input");a&&t.lastIdx===d.no||(t.lastIdx=d.no,t.obsManager.forEach(r=>r.disconnect()),t.obsManager=[],d.type=i,H[i]?.({el:h,question:d,restore:f,...t}),o?.addEventListener("change",async()=>{d.is_new=o?.checked||!1,await L(d)}),D(d),S(d),await L(d))};$(t,s,c,n),setInterval(()=>c(),800),c()})();
