const S=(...e)=>console.log("%cR%cE%cC%cO%cR%cD","color: #03FFFF; font-weight: bold;","color: #56FFAA; font-weight: bold;","color: #AAFF55; font-weight: bold;","color: #FFFF00; font-weight: bold;","color: #FF8080; font-weight: bold;","color: #FF00FF; font-weight: bold;",...e),p=(e,t=document)=>t.querySelector(e),y=(e,t=document)=>Array.from(t.querySelectorAll(e)),_=e=>e.normalize("NFKC").replace(/\s+/g," ").trim(),M=e=>e?.match(/\d+/)?e.match(/\d+/)[0]:"0",Q=e=>e&&!e.startsWith("Kéo và thả"),h=e=>_(e?.innerText||"");async function E({el:e,question:t,restore:n,isRadio:r=!1,parentQuestion:c=null}){const s=y(".mdc-form-field",e),i=[],l=n?.find(o=>_(o?.text)===t.text&&o?.type===t.type)?.options||[],f=A(async()=>await F(c||t));for(const o of s){const a=p("input",o),b=p("label",o),u=p("img",o),g={is_correct:a?.checked||!1},x=h(b).replace(/^[*]?[A-Z]\.\s*/,"");x&&(g.text=x),u?.src&&(g.img_src=u.src),a?.addEventListener("change",()=>{r&&i.forEach(w=>w.is_correct=!1),g.is_correct=a.checked,f()});const m=l.find(w=>_(w.text)===x);m&&m.is_correct&&!a.checked&&(a.click(),g.is_correct=a.checked,a.dispatchEvent(new Event("change",{bubbles:!0}))),i.push(g)}t.options=i}function T(e,t,n,r,c=!1){const s=y(":scope > :nth-child(2) > div",e),i=y(":scope > div .cdk-drag",e),d=new Set(t.candidates),l=A(async()=>await F(t));i.forEach(o=>{const a=h(o);d.has(a)||(t.candidates.push(a),d.add(a))});const f=r?.find(o=>_(o?.text)===t.text);s.forEach(o=>{const a=h(p("h4",o)),b=p(":scope > div",o),u={text:a.replace(/^\d+\)\s*/,""),...c?{answers:[]}:{answer:""}},g=()=>{if(c)u.answers=Array.from(b.children).map(h).filter(Q);else{const v=h(b);u.answer=Q(v)?v:""}};g(),t.drag_map.push(u);const x=D(()=>{const v=c?u.answers.join(","):u.answer;g();const R=c?u.answers.join(","):u.answer;v!==R&&l()});x.observe(b,{childList:!0,subtree:c}),n.push(x);const m=f?.drag_map?.find(v=>v.text===u.text),w=p(":scope >p",b);if(m&&w){const v=m.answers||[m.answer];w.innerText=v.join(", ")}else!m&&w&&(w.innerText="Kéo và thả đáp án vào đây")})}function C(e){["sub_questions","input_answers","candidates","drag_map","img_src","options","text"].forEach(n=>{e?.[n]?.length||delete e[n]})}const k=[];async function F(e){k[e.no-1]=e;const t=await I("test",k);S(t?"Saved":"Failed")}function D(e){return new MutationObserver(e)}function A(e,t=400){let n;return(...r)=>{clearTimeout(n),n=setTimeout(()=>e(...r),t)}}async function I(e,t){if(!chrome?.storage?.local)return!1;try{return await chrome.storage.local.set({[e]:t}),!0}catch{return!1}}async function L(e){if(chrome?.storage?.local)try{return(await chrome.storage.local.get(e))[e]}catch{return null}}function K(){return{no:M(h(p("fieldset legend"))),text:h(p("fieldset div")),img_src:p("fieldset img")?.src||"",sub_questions:[],input_answers:[],candidates:[],drag_map:[],options:[]}}function $(e){const t=h(p(":scope > label",e));return{no:M(h(p(":scope > label > b",e))),text:t.replace(/^\d+\)\s*/,"")}}function j(){const e=["radio","group-radio","check-box","grouping-2","drag-drop-2","group-input"];for(const t of e){const n=p(`question-type-${t}`);if(n)return{type:t,el:n}}return{type:"unknown",el:null}}function G({el:e,question:t,restore:n}){E({el:e,question:t,restore:n,isRadio:!0})}async function O({el:e,question:t,restore:n}){const r=y(".question-type-group-radio__element",e),c=n?.filter(s=>s?.type==="group-radio"&&Array.isArray(s.sub_questions)).flatMap(s=>s.sub_questions)||[];for(const s of r){const i=$(s);E({el:s,question:i,isRadio:!0,parentQuestion:t,restore:c}),t.sub_questions.push(i)}}function Z({el:e,question:t,restore:n}){E({el:e,question:t,restore:n})}function z({el:e,question:t,obsManager:n,restore:r}){T(e,t,n,r,!0)}function B({el:e,question:t,obsManager:n,restore:r}){T(e,t,n,r,!1)}async function N({el:e,question:t,restore:n}){const r=y("label",e),c=y("input",e),s=A(async()=>await F(t)),d=n?.find(l=>_(l?.text)===t.text&&l?.type===t.type)?.input_answers||[];for(let l=0;l<r.length;l++){const f=r[l],o=c[l],a=h(f).replace(/^\d+\)\s*/,""),b={text:a,value:o?.value||""};t.input_answers.push(b),o?.addEventListener("input",()=>{b.value=o.value,s()});const u=d.find(g=>_(g?.text)===a);u?.value&&(o.value=u.value,o.dispatchEvent(new Event("input",{bubbles:!0})))}}const P={radio:(...e)=>G(...e),"group-radio":(...e)=>O(...e),"check-box":(...e)=>Z(...e),"grouping-2":(...e)=>z(...e),"drag-drop-2":(...e)=>B(...e),"group-input":(...e)=>N(...e)};(async()=>{if(!(location.hostname==="lms.ictu.edu.vn"||location.protocol==="file:"))return;console.clear();const t={lastIdx:0,obsManager:[],active:!0},n=p(".app-version"),r=await L("status");t.active=r!==!1,n?.classList?.toggle("off",!t.active),document.addEventListener("keydown",async({ctrlKey:s,code:i})=>{if(i==="Backslash"&&(t.active=!t.active,c(!1),await I("status",t.active).then(d=>S(d&&t.active?"on":"off")),n?.classList?.toggle("off",!t.active)),s&&i==="KeyC"){const d=getSelection()?.toString();d&&navigator.clipboard.writeText(d).catch(console.error)}}),window.addEventListener("contextmenu",s=>s.stopPropagation(),!0);const c=async(s=!0)=>{const{type:i,el:d}=j();if(!d)return;const l=t.active?await L("restore"):[],f=K();s&&t.lastIdx===f.no||(t.lastIdx=f.no,t.obsManager.forEach(o=>o.disconnect()),t.obsManager=[],f.type=i,P[i]?.({el:d,question:f,restore:l,...t}),C(f),S(f),await F(f))};n?.addEventListener("click",()=>{c(!1)}),setInterval(()=>c(),2e3),c()})();
