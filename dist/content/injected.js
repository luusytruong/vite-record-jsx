const E=(...e)=>console.log("%cR%cE%cC%cO%cR%cD","color: #03FFFF; font-weight: bold;","color: #56FFAA; font-weight: bold;","color: #AAFF55; font-weight: bold;","color: #FFFF00; font-weight: bold;","color: #FF8080; font-weight: bold;","color: #FF00FF; font-weight: bold;",...e),f=(e,t=document)=>t.querySelector(e),x=(e,t=document)=>Array.from(t.querySelectorAll(e)),_=e=>e.normalize("NFKC").replace(/\s+/g," ").trim(),R=e=>e?.match(/\d+/)?e.match(/\d+/)[0]:"0",S=e=>e&&!e.startsWith("Kéo và thả"),v=e=>_(e?.innerText||"");async function L({el:e,question:t,restore:n,isRadio:r=!1,parentQuestion:a=null,multiple:i=!1}){const g=x(i?"mat-radio-button":".mdc-form-field",e),d=[],p=n?.find(c=>_(c?.text)===t.text&&c?.type===t.type)?.options||[],o=Q(async()=>await F(a||t));for(const c of g){const u=f("input",c),l=f("label",c),b=f("img",c),m={is_correct:u?.checked||!1},w=v(l).replace(/^[*]?[A-Z]\.\s*/,"");w&&(m.text=w),b?.src&&(m.img_src=b.src),u?.addEventListener("change",()=>{r&&d.forEach(h=>h.is_correct=!1),m.is_correct=u.checked||!1,c.classList.remove("vite-record"),o()});const y=p.find(h=>_(h.text)===w);y&&y.is_correct&&!u.checked?c.classList.add("vite-record"):c.classList.remove("vite-record"),d.push(m)}t.options=d}function D(e,t,n,r,a=!1){const i=x(":scope > :nth-child(2) > div",e),g=x(":scope > div .cdk-drag",e),d=new Set(t.candidates),s=Q(async()=>await F(t));g.forEach(o=>{const c=v(o);d.has(c)||(t.candidates.push(c),d.add(c))});const p=r?.find(o=>_(o?.text)===t.text);i.forEach(o=>{const c=v(f("h4",o)),u=f(":scope > div",o),l={text:c.replace(/^\d+\)\s*/,""),...a?{answers:[]}:{answer:""}},b=()=>{if(a)l.answers=Array.from(u.children).map(v).filter(S);else{const h=v(u);l.answer=S(h)?h:""}};b(),t.drag_map.push(l);const m=I(()=>{const h=a?l.answers.join(","):l.answer;b();const K=a?l.answers.join(","):l.answer;h!==K&&s()});m.observe(u,{childList:!0,subtree:a}),n.push(m);const w=p?.drag_map?.find(h=>h.text===l.text),y=f(":scope >p",u);if(w&&y){const h=w.answers||[w.answer];y.innerText=h.join(", ")}else!w&&y&&(y.innerText="Kéo và thả đáp án vào đây")})}function C(e){["sub_questions","input_answers","candidates","drag_map","img_src","options","text"].forEach(n=>{e?.[n]?.length||delete e[n]})}const A=[];async function F(e){A[e.no-1]=e;const t=await k("test",A);E(t?"Saved":"Failed")}function I(e){return new MutationObserver(e)}function Q(e,t=400){let n;return(...r)=>{clearTimeout(n),n=setTimeout(()=>e(...r),t)}}async function k(e,t){if(!chrome?.storage?.local)return!1;try{return await chrome.storage.local.set({[e]:t}),!0}catch{return!1}}async function M(e){if(chrome?.storage?.local)try{return(await chrome.storage.local.get(e))[e]}catch{return null}}function O(e,t,n,r){r?.addEventListener("click",async()=>n(!1));const a=["contextmenu","visibilitychange","fullscreenchange","fullscreenerror","pointerlockchange","pointerlockerror","mouseleave","mouseenter","blur","focus","keydown"];for(const i of a)for(const g of[document,window])g.addEventListener(i,async d=>{if(d.target.tagName!=="INPUT"&&(d.stopImmediatePropagation(),d instanceof KeyboardEvent)){const s=d.code||"";(s==="ShiftRight"||s==="")&&(e.active=!e.active,n(!1),await k("settings",{...t,toggle:e.active}).then(p=>E(p&&e.active?"on":"off")),r?.classList?.toggle("on",e.active)),s==="Slash"&&(e.mode=e.mode==="cur"?"color":"cur",document.body.classList.toggle("cur",e.mode==="cur"),await k("settings",{...t,mode:e.mode}).then(p=>E(p?"mode changed":"mode not changed"))),d.altKey&&s==="KeyF"&&(window.__MODER__=!0,document.fullscreenElement?await document.exitFullscreen():await document.body.requestFullscreen(),window.__MODER__=!1)}},!0)}function N(){return{is_new:f("input[type=checkbox]")?.checked||!1,no:R(v(f("fieldset legend"))),text:v(f("fieldset div")),img_src:f("fieldset img")?.src||"",sub_questions:[],input_answers:[],candidates:[],drag_map:[],options:[]}}function $(e){const t=v(f(":scope > label",e));return{no:R(v(f(":scope > label > b",e))),text:t.replace(/^\d+\)\s*/,"")}}function j(){const e=["radio","group-radio","check-box","grouping-2","drag-drop-2","group-input"];for(const t of e){const n=f(`question-type-${t}`);if(n)return{type:t,el:n}}return{type:"unknown",el:null}}function G({el:e,question:t,restore:n}){L({el:e,question:t,restore:n,isRadio:!0})}async function W({el:e,question:t,restore:n}){const r=x(".question-type-group-radio__element",e),a=n?.filter(i=>i?.type==="group-radio"&&Array.isArray(i.sub_questions)).flatMap(i=>i.sub_questions)||[];for(const i of r){const g=$(i);L({el:i,question:g,isRadio:!0,parentQuestion:t,restore:a,multiple:!0}),t.sub_questions.push(g)}}function Z({el:e,question:t,restore:n}){L({el:e,question:t,restore:n})}function z({el:e,question:t,obsManager:n,restore:r}){D(e,t,n,r,!0)}function P({el:e,question:t,obsManager:n,restore:r}){D(e,t,n,r,!1)}const T=new WeakMap;async function B({el:e,question:t,restore:n}){const r=x("label",e),a=x("input",e),i=Q(async()=>await F(t)),d=n?.find(s=>_(s?.text)===t.text&&s?.type===t.type)?.input_answers||[];for(let s=0;s<r.length;s++){const p=r[s],o=a[s],c=v(p).replace(/^\d+\)\s*/,""),u={text:c,value:o?.value||""};t.input_answers.push(u),o?.addEventListener("input",()=>{u.value=o.value,i()});const l=d.find(w=>_(w?.text)===c),b=async()=>{l?.value&&(await navigator.clipboard.writeText(l.value),o.placeholder=l.value)},m=T.get(o);m&&o?.removeEventListener("focus",m),o?.addEventListener("focus",b),T.set(o,b),o?.addEventListener("blur",()=>o.placeholder="")}}const U={radio:(...e)=>G(...e),"group-radio":(...e)=>W(...e),"check-box":(...e)=>Z(...e),"grouping-2":(...e)=>z(...e),"drag-drop-2":(...e)=>P(...e),"group-input":(...e)=>B(...e)};(async()=>{if(!/(lms\.ictu\.edu\.vn|file:)/.test(location.href))return;console.clear();const e={lastQuestion:{},obsManager:[],active:!0,mode:"cur"},t=await M("settings"),n=f(".app-version"),r=new WeakMap;e.active=t?.toggle!==!1,e.mode=t?.mode||"cur",document.body.classList.toggle("cur",e.mode==="cur"),n?.classList?.toggle("on",e.active);const a=async(i=!0)=>{const{type:g,el:d}=j();if(!d)return;const s=N();if(i&&e.lastQuestion?.no===s.no)return;e.lastQuestion=s;const p=e.active?await M("restore"):[],o=f("input[type=checkbox]"),c=r.get(o);c&&o?.removeEventListener("change",c);const u=async()=>{e.lastQuestion.is_new=o?.checked||!1,await F(e.lastQuestion)};o?.addEventListener("change",u),r.set(o,u),e.obsManager.forEach(l=>l.disconnect()),e.obsManager=[],s.type=g,U[g]?.({el:d,question:s,restore:p,...e}),C(s),E("after cl",s),await F(s)};O(e,t,a,n),setInterval(a,600),a()})();
