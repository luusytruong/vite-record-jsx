const L=(...e)=>console.log("%cR%cE%cC%cO%cR%cD","color: #03FFFF; font-weight: bold;","color: #56FFAA; font-weight: bold;","color: #AAFF55; font-weight: bold;","color: #FFFF00; font-weight: bold;","color: #FF8080; font-weight: bold;","color: #FF00FF; font-weight: bold;",...e),u=(e,t=document)=>t.querySelector(e),x=(e,t=document)=>Array.from(t.querySelectorAll(e)),_=e=>e.normalize("NFKC").replace(/\s+/g," ").trim(),R=e=>e?.match(/\d+/)?e.match(/\d+/)[0]:"0",k=e=>e&&!e.startsWith("Kéo và thả"),b=e=>_(e?.innerText||"");async function E({el:e,question:t,restore:n,isRadio:c=!1,parentQuestion:r=null,multiple:a=!1}){const f=x(a?"mat-radio-button":".mdc-form-field",e),i=[],p=n?.find(o=>_(o?.text)===t.text&&o?.type===t.type)?.options||[],s=Q(async()=>await F(r||t));for(const o of f){const l=u("input",o),d=u("label",o),m=u("img",o),v={is_correct:l?.checked||!1},w=b(d).replace(/^[*]?[A-Z]\.\s*/,"");w&&(v.text=w),m?.src&&(v.img_src=m.src),l?.addEventListener("change",()=>{c&&i.forEach(h=>h.is_correct=!1),v.is_correct=l.checked||!1,o.classList.remove("vite-record"),s()});const y=p.find(h=>_(h.text)===w);y&&y.is_correct&&!l.checked?o.classList.add("vite-record"):o.classList.remove("vite-record"),i.push(v)}t.options=i}function C(e,t,n,c,r=!1){const a=x(":scope > :nth-child(2) > div",e),f=x(":scope > div .cdk-drag",e),i=new Set(t.candidates),g=Q(async()=>await F(t));f.forEach(s=>{const o=b(s);i.has(o)||(t.candidates.push(o),i.add(o))});const p=c?.find(s=>_(s?.text)===t.text);a.forEach(s=>{const o=b(u("h4",s)),l=u(":scope > div",s),d={text:o.replace(/^\d+\)\s*/,""),...r?{answers:[]}:{answer:""}},m=()=>{if(r)d.answers=Array.from(l.children).map(b).filter(k);else{const h=b(l);d.answer=k(h)?h:""}};m(),t.drag_map.push(d);const v=K(()=>{const h=r?d.answers.join(","):d.answer;m();const D=r?d.answers.join(","):d.answer;h!==D&&g()});v.observe(l,{childList:!0,subtree:r}),n.push(v);const w=p?.drag_map?.find(h=>h.text===d.text),y=u(":scope >p",l);if(w&&y){const h=w.answers||[w.answer];y.innerText=h.join(", ")}else!w&&y&&(y.innerText="Kéo và thả đáp án vào đây")})}function I(e){["sub_questions","input_answers","candidates","drag_map","img_src","options","text"].forEach(n=>{e?.[n]?.length||delete e[n]})}const A=[];async function F(e){A[e.no-1]=e;const t=await S("test",A);L(t?"Saved":"Failed")}function K(e){return new MutationObserver(e)}function Q(e,t=400){let n;return(...c)=>{clearTimeout(n),n=setTimeout(()=>e(...c),t)}}async function S(e,t){if(!chrome?.storage?.local)return!1;try{return await chrome.storage.local.set({[e]:t}),!0}catch{return!1}}async function M(e){if(chrome?.storage?.local)try{return(await chrome.storage.local.get(e))[e]}catch{return null}}function $(e,t,n,c){c?.addEventListener("click",async()=>n(!1)),document.addEventListener("contextmenu",r=>r.stopImmediatePropagation(),!0),document.addEventListener("keydown",async r=>{const{ctrlKey:a,code:f}=r;if(a&&f==="KeyC"){const i=getSelection()?.toString();i&&navigator.clipboard.writeText(i).catch(console.error)}(f==="ShiftRight"||f==="")&&(e.active=!e.active,n(!1),await S("settings",{...t,toggle:e.active}).then(i=>L(i&&e.active?"on":"off")),c?.classList?.toggle("on",e.active)),f==="Slash"&&(e.mode=e.mode==="cur"?"color":"cur",document.body.classList.toggle("cur",e.mode==="cur"),await S("settings",{...t,mode:e.mode}).then(i=>L(i?"mode changed":"mode not changed"))),r.stopImmediatePropagation()},!0)}function j(){return{is_new:u("input[type=checkbox]")?.checked||!1,no:R(b(u("fieldset legend"))),text:b(u("fieldset div")),img_src:u("fieldset img")?.src||"",sub_questions:[],input_answers:[],candidates:[],drag_map:[],options:[]}}function G(e){const t=b(u(":scope > label",e));return{no:R(b(u(":scope > label > b",e))),text:t.replace(/^\d+\)\s*/,"")}}function O(){const e=["radio","group-radio","check-box","grouping-2","drag-drop-2","group-input"];for(const t of e){const n=u(`question-type-${t}`);if(n)return{type:t,el:n}}return{type:"unknown",el:null}}function W({el:e,question:t,restore:n}){E({el:e,question:t,restore:n,isRadio:!0})}async function Z({el:e,question:t,restore:n}){const c=x(".question-type-group-radio__element",e),r=n?.filter(a=>a?.type==="group-radio"&&Array.isArray(a.sub_questions)).flatMap(a=>a.sub_questions)||[];for(const a of c){const f=G(a);E({el:a,question:f,isRadio:!0,parentQuestion:t,restore:r,multiple:!0}),t.sub_questions.push(f)}}function z({el:e,question:t,restore:n}){E({el:e,question:t,restore:n})}function N({el:e,question:t,obsManager:n,restore:c}){C(e,t,n,c,!0)}function P({el:e,question:t,obsManager:n,restore:c}){C(e,t,n,c,!1)}const T=new WeakMap;async function B({el:e,question:t,restore:n}){const c=x("label",e),r=x("input",e),a=Q(async()=>await F(t)),i=n?.find(g=>_(g?.text)===t.text&&g?.type===t.type)?.input_answers||[];for(let g=0;g<c.length;g++){const p=c[g],s=r[g],o=b(p).replace(/^\d+\)\s*/,""),l={text:o,value:s?.value||""};t.input_answers.push(l),s?.addEventListener("input",()=>{l.value=s.value,a()});const d=i.find(w=>_(w?.text)===o),m=async()=>{d?.value&&(await navigator.clipboard.writeText(d.value),s.placeholder=d.value)},v=T.get(s);v&&s?.removeEventListener("focus",v),s?.addEventListener("focus",m),T.set(s,m),s?.addEventListener("blur",()=>s.placeholder="")}}const H={radio:(...e)=>W(...e),"group-radio":(...e)=>Z(...e),"check-box":(...e)=>z(...e),"grouping-2":(...e)=>N(...e),"drag-drop-2":(...e)=>P(...e),"group-input":(...e)=>B(...e)};(async()=>{if(!(location.hostname==="lms.ictu.edu.vn"||location.protocol==="file:"))return;console.clear();const t={lastQuestion:{},obsManager:[],active:!0,mode:"cur"},n=await M("settings"),c=u(".app-version"),r=new WeakMap;t.active=n?.toggle!==!1,t.mode=n?.mode||"cur",document.body.classList.toggle("cur",t.mode==="cur"),c?.classList?.toggle("on",t.active);const a=async(f=!0)=>{const{type:i,el:g}=O();if(!g)return;const p=j();if(f&&t.lastQuestion?.no===p.no)return;t.lastQuestion=p;const s=t.active?await M("restore"):[],o=u("input[type=checkbox]"),l=r.get(o);l&&o?.removeEventListener("change",l);const d=async()=>{t.lastQuestion.is_new=o?.checked||!1,await F(t.lastQuestion)};o?.addEventListener("change",d),r.set(o,d),t.obsManager.forEach(m=>m.disconnect()),t.obsManager=[],p.type=i,H[i]?.({el:g,question:p,restore:s,...t}),I(p),L("after clean",p),await F(p)};$(t,n,a,c),setInterval(()=>a(),600),a()})();
