const u=(e,t=document)=>t.querySelector(e),m=(e,t=document)=>Array.from(t.querySelectorAll(e)),F=(...e)=>console.log("%cR%cE%cC%cO%cR%cD","color: #03FFFF; font-weight: bold;","color: #56FFAA; font-weight: bold;","color: #AAFF55; font-weight: bold;","color: #FFFF00; font-weight: bold;","color: #FF8080; font-weight: bold;","color: #FF00FF; font-weight: bold;",...e),k=e=>e.normalize("NFKC").replace(/\s+/g," ").trim(),M=e=>e.match(/\d+/)?e.match(/\d+/)[0]:"0";function S({el:e,question:t,restore:n,isRadio:s=!1,parentQuestion:o=null}){const c=m(".mdc-form-field",e),f=[],p=n?.find(r=>r?.text===t.text&&r?.type===t.type)?.options||[],g=Q(()=>_(o||t));for(const r of c){const a=u("input",r),i=u("label",r),h=u("img",r),d={is_correct:a?.checked||!1},y=l(i);y&&(d.text=y),h?.src&&(d.img_src=h.src),a?.addEventListener("change",()=>{s&&f.forEach(x=>x.is_correct=!1),d.is_correct=a.checked,g()});const w=p.find(x=>x.text===y);w&&w.is_correct&&(a.click(),d.is_correct=a.checked,a.dispatchEvent(new Event("change",{bubbles:!0}))),f.push(d)}t.options=f}function T(e,t,n,{restore:s,multiple:o=!1}){const c=m(":scope > :nth-child(2) > div",e),f=m(":scope > div .cdk-drag",e),v=new Set(t.candidates),p=Q(()=>_(t));f.forEach(g=>{const r=l(g);v.has(r)||(t.candidates.push(r),v.add(r))}),c.forEach(g=>{const r=l(u("h4",g)),a=u(":scope > div",g),i={text:r.replace(/^\d+\)\s*/,""),...o?{answers:[]}:{answer:""}},h=()=>{if(o)i.answers=Array.from(a.children).map(l).filter(A);else{const b=l(a);i.answer=A(b)?b:""}};h(),t.drag_map.push(i);const d=C(()=>{const b=o?i.answers.join(","):i.answer;h();const L=o?i.answers.join(","):i.answer;b!==L&&p()});d.observe(a,{childList:!0,subtree:o}),n.push(d);const w=s?.find(b=>b?.text===t.text)?.drag_map?.find(b=>b.text===i.text);if(!w)return;const x=(w.answers||[w.answer]).join(", "),E=u(":scope >p",a);E&&(E.innerText=x)})}function I(e){["sub_questions","input_answers","candidates","drag_map","img_src","options","text"].forEach(n=>{e?.[n]?.length||delete e[n]})}function _(...e){window.postMessage({source:"page-script",payload:e},"*")}async function R(e,t){const n=await D(e,t);F(n?"Saved to storage":"Failed to save to storage")}function C(e){return new MutationObserver(e)}const A=e=>e&&!e.startsWith("Kéo và thả"),l=e=>e?.innerText?.trim()||"";function Q(e,t=500){let n;return(...s)=>{clearTimeout(n),n=setTimeout(()=>e(...s),t)}}async function D(e,t){if(!chrome?.storage?.local)return!1;try{return await chrome.storage.local.set({[e]:t}),!0}catch{return!1}}async function $(e){if(chrome?.storage?.local)try{return(await chrome.storage.local.get(e))[e]}catch{return null}}function j(){return{no:M(l(u("fieldset legend"))),text:k(l(u("fieldset div"))),img_src:u("fieldset img")?.src||"",sub_questions:[],input_answers:[],candidates:[],drag_map:[],options:[]}}function G(e){const t=k(l(u(":scope > label",e)));return{no:M(l(u(":scope > label > b",e))),text:t.replace(/^\d+\)\s*/,"")}}function O(){const e=["radio","group-radio","check-box","grouping-2","drag-drop-2","group-input"];for(const t of e){const n=u(`question-type-${t}`);if(n)return{type:t,el:n}}return{type:"unknown",el:null}}function z({el:e,question:t,restore:n}){S({el:e,question:t,restore:n,isRadio:!0})}function K({el:e,question:t,restore:n}){const s=m(".question-type-group-radio__element",e),o=n?.filter(c=>c?.type==="group-radio"&&Array.isArray(c.sub_questions)).flatMap(c=>c.sub_questions)||[];for(const c of s){const f=G(c);S({el:c,question:f,isRadio:!0,parentQuestion:t,restore:o}),t.sub_questions.push(f)}}function N({el:e,question:t,restore:n}){S({el:e,question:t,restore:n})}function W({el:e,question:t,observerManager:n,restore:s}){T(e,t,n,{restore:s,multiple:!0})}function Z({el:e,question:t,observerManager:n,restore:s}){T(e,t,n,{restore:s,multiple:!1})}function B({el:e,question:t,restore:n}){const s=m("label",e),o=m("input",e),c=Q(()=>_(t));console.log(n);const v=n.find(p=>p?.text===t.text&&p?.type===t.type)?.input_answers||[];s.forEach((p,g)=>{const r=o[g],a=l(p).replace(/^\d+\)\s*/,""),i={text:a,value:r?.value||""};t.input_answers.push(i),r?.addEventListener("input",()=>{i.value=r.value,c()});const h=v.find(d=>d.text===a);h?.value&&(r.value=h.value,r.dispatchEvent(new Event("input",{bubbles:!0})))})}const H={radio:(...e)=>z(...e),"group-radio":(...e)=>K(...e),"check-box":(...e)=>N(...e),"grouping-2":(...e)=>W(...e),"drag-drop-2":(...e)=>Z(...e),"group-input":(...e)=>B(...e)};(()=>{if(!(location.hostname==="lms.ictu.edu.vn"||location.href.startsWith("file")))return;console.clear();const t={lastIndex:0,observers:[],restore:[],test:[]};window.addEventListener("message",async({source:n,data:s})=>{if(n===window&&s?.source==="page-script"){const o=s.payload[0];t.test[o.no-1]=o,await R("test",t.test)}}),setInterval(async()=>{const{type:n,el:s}=O();if(!s)return;t.restore=await $("restore");const o=j();o.no!==t.lastIndex&&(t.observers.forEach(c=>c.disconnect()),t.observers=[],o.type=n,H[n]?.({el:s,question:o,observerManager:t.observers,...t}),I(o),_(o),F(o),t.lastIndex=o.no)},1e3)})();
