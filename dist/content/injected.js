const S=(...e)=>console.log("%cR%cE%cC%cO%cR%cD","color: #03FFFF; font-weight: bold;","color: #56FFAA; font-weight: bold;","color: #AAFF55; font-weight: bold;","color: #FFFF00; font-weight: bold;","color: #FF8080; font-weight: bold;","color: #FF00FF; font-weight: bold;",...e),u=(e,t=document)=>t.querySelector(e),x=(e,t=document)=>Array.from(t.querySelectorAll(e)),_=e=>e.normalize("NFKC").replace(/\s+/g," ").trim(),C=e=>e?.match(/\d+/)?e.match(/\d+/)[0]:"0",M=e=>e&&!e.startsWith("Kéo và thả"),b=e=>_(e?.innerText||"");async function E({el:e,question:t,restore:o,isRadio:s=!1,parentQuestion:r=null,multiple:c=!1}){const a=x(c?"mat-radio-button":".mdc-form-field",e),h=[],l=o?.find(i=>_(i?.text)===t.text&&i?.type===t.type)?.options||[],n=Q(async()=>await L(r||t));for(const i of a){const g=u("input",i),d=u("label",i),v=u("img",i),m={is_correct:g?.checked||!1},w=b(d).replace(/^[*]?[A-Z]\.\s*/,"");w&&(m.text=w),v?.src&&(m.img_src=v.src);const y=()=>{s&&h.forEach(F=>F.is_correct=!1),m.is_correct=g.checked,n()};g?.addEventListener("change",y);const p=l.find(F=>_(F.text)===w);p&&p.is_correct&&!g.checked?i.classList.add("vite-record"):i.classList.remove("vite-record"),h.push(m)}t.options=h}function I(e,t,o,s,r=!1){const c=x(":scope > :nth-child(2) > div",e),a=x(":scope > div .cdk-drag",e),h=new Set(t.candidates),f=Q(async()=>await L(t));a.forEach(n=>{const i=b(n);h.has(i)||(t.candidates.push(i),h.add(i))});const l=s?.find(n=>_(n?.text)===t.text);c.forEach(n=>{const i=b(u("h4",n)),g=u(":scope > div",n),d={text:i.replace(/^\d+\)\s*/,""),...r?{answers:[]}:{answer:""}},v=()=>{if(r)d.answers=Array.from(g.children).map(b).filter(M);else{const p=b(g);d.answer=M(p)?p:""}};v(),t.drag_map.push(d);const m=K(()=>{const p=r?d.answers.join(","):d.answer;v();const F=r?d.answers.join(","):d.answer;p!==F&&f()});m.observe(g,{childList:!0,subtree:r}),o.push(m);const w=l?.drag_map?.find(p=>p.text===d.text),y=u(":scope >p",g);if(w&&y){const p=w.answers||[w.answer];y.innerText=p.join(", ")}else!w&&y&&(y.innerText="Kéo và thả đáp án vào đây")})}function D(e){["sub_questions","input_answers","candidates","drag_map","img_src","options","text"].forEach(o=>{e?.[o]?.length||delete e[o]})}const k=[];async function L(e){k[e.no-1]=e;const t=await A("test",k);S(t?"Saved":"Failed")}function K(e){return new MutationObserver(e)}function Q(e,t=400){let o;return(...s)=>{clearTimeout(o),o=setTimeout(()=>e(...s),t)}}async function A(e,t){if(!chrome?.storage?.local)return!1;try{return await chrome.storage.local.set({[e]:t}),!0}catch{return!1}}async function T(e){if(chrome?.storage?.local)try{return(await chrome.storage.local.get(e))[e]}catch{return null}}function $(e,t,o,s){document.addEventListener("keydown",async({ctrlKey:r,code:c})=>{if(r&&c==="KeyC"){const a=getSelection()?.toString();a&&navigator.clipboard.writeText(a).catch(console.error)}c==="ShiftRight"&&(e.active=!e.active,o(!1),await A("settings",{...t,toggle:e.active}).then(a=>S(a&&e.active?"on":"off")),s?.classList?.toggle("on",e.active)),c==="Slash"&&(e.mode=e.mode==="cursor"?"color":"cursor",document.body.classList.toggle("cursor",e.mode==="cursor"),await A("settings",{...t,mode:e.mode}).then(a=>S(a?"mode changed":"mode not changed")))}),window.addEventListener("contextmenu",r=>r.stopPropagation(),!0)}function j(){return{no:C(b(u("fieldset legend"))),text:b(u("fieldset div")),img_src:u("fieldset img")?.src||"",sub_questions:[],input_answers:[],candidates:[],drag_map:[],options:[]}}function G(e){const t=b(u(":scope > label",e));return{no:C(b(u(":scope > label > b",e))),text:t.replace(/^\d+\)\s*/,"")}}function O(){const e=["radio","group-radio","check-box","grouping-2","drag-drop-2","group-input"];for(const t of e){const o=u(`question-type-${t}`);if(o)return{type:t,el:o}}return{type:"unknown",el:null}}function Z({el:e,question:t,restore:o}){E({el:e,question:t,restore:o,isRadio:!0})}async function z({el:e,question:t,restore:o}){const s=x(".question-type-group-radio__element",e),r=o?.filter(c=>c?.type==="group-radio"&&Array.isArray(c.sub_questions)).flatMap(c=>c.sub_questions)||[];for(const c of s){const a=G(c);E({el:c,question:a,isRadio:!0,parentQuestion:t,restore:r,multiple:!0}),t.sub_questions.push(a)}}function N({el:e,question:t,restore:o}){E({el:e,question:t,restore:o})}function W({el:e,question:t,obsManager:o,restore:s}){I(e,t,o,s,!0)}function B({el:e,question:t,obsManager:o,restore:s}){I(e,t,o,s,!1)}const R=new WeakMap;async function P({el:e,question:t,restore:o}){const s=x("label",e),r=x("input",e),c=Q(async()=>await L(t)),h=o?.find(f=>_(f?.text)===t.text&&f?.type===t.type)?.input_answers||[];for(let f=0;f<s.length;f++){const l=s[f],n=r[f],i=b(l).replace(/^\d+\)\s*/,""),g={text:i,value:n?.value||""};t.input_answers.push(g),n?.addEventListener("input",()=>{g.value=n.value,c()});const d=h.find(w=>_(w?.text)===i),v=async()=>{d?.value&&(await navigator.clipboard.writeText(d.value),n.placeholder=d.value)},m=R.get(n);m&&n?.removeEventListener("focus",m),n?.addEventListener("focus",v),R.set(n,v),n?.addEventListener("blur",()=>n.placeholder="")}}const H={radio:(...e)=>Z(...e),"group-radio":(...e)=>z(...e),"check-box":(...e)=>N(...e),"grouping-2":(...e)=>W(...e),"drag-drop-2":(...e)=>B(...e),"group-input":(...e)=>P(...e)};(async()=>{if(!(location.hostname==="lms.ictu.edu.vn"||location.protocol==="file:"))return;console.clear();const t={lastIdx:0,obsManager:[],active:!0,mode:"cursor"},o=u(".app-version"),s=await T("settings");t.active=s?.toggle!==!1,t.mode=s?.mode||"cursor",document.body.classList.toggle("cursor",t.mode==="cursor"),o?.classList?.toggle("on",t.active);const r=async(c=!0)=>{const{type:a,el:h}=O();if(!h)return;const f=t.active?await T("restore"):[],l=j();c&&t.lastIdx===l.no||(t.lastIdx=l.no,t.obsManager.forEach(n=>n.disconnect()),t.obsManager=[],l.type=a,H[a]?.({el:h,question:l,restore:f,...t}),D(l),S(l),await L(l))};$(t,s,r,o),setInterval(()=>r(),800),r()})();
