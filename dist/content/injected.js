const u=(e,t=document)=>t.querySelector(e),m=(e,t=document)=>Array.from(t.querySelectorAll(e)),_=(...e)=>console.log("%cR%cE%cC%cO%cR%cD","color: #03FFFF; font-weight: bold;","color: #56FFAA; font-weight: bold;","color: #AAFF55; font-weight: bold;","color: #FFFF00; font-weight: bold;","color: #FF8080; font-weight: bold;","color: #FF00FF; font-weight: bold;",...e),Q=e=>e.normalize("NFKC").replace(/\s+/g," ").trim(),k=e=>e.match(/\d+/)?e.match(/\d+/)[0]:"0";function F({el:e,question:t,restore:n,isRadio:s=!1,parentQuestion:o=null}){const c=m(".mdc-form-field",e),p=[],h=n?.find(r=>r?.text===t.text&&r?.type===t.type)?.options||[],b=S(()=>y(o||t));for(const r of c){const a=u("input",r),i=u("label",r),w=u("img",r),l={is_correct:a?.checked||!1},x=f(i);x&&(l.text=x),w?.src&&(l.img_src=w.src),a?.addEventListener("change",()=>{s&&p.forEach(g=>g.is_correct=!1),l.is_correct=a.checked,b()});const d=h.find(g=>g.text===x);d&&d.is_correct&&(a.click(),l.is_correct=a.checked,a.dispatchEvent(new Event("change",{bubbles:!0}))),p.push(l)}t.options=p}function L(e,t,n,{restore:s,multiple:o=!1}){const c=m(":scope > :nth-child(2) > div",e),p=m(":scope > div .cdk-drag",e),v=new Set(t.candidates),h=S(()=>y(t));p.forEach(b=>{const r=f(b);v.has(r)||(t.candidates.push(r),v.add(r))}),c.forEach(b=>{const r=f(u("h4",b)),a=u(":scope > div",b),i={text:r.replace(/^\d+\)\s*/,""),...o?{answers:[]}:{answer:""}},w=()=>{if(o)i.answers=Array.from(a.children).map(f).filter(A);else{const d=f(a);i.answer=A(d)?d:""}};w(),t.drag_map.push(i);const l=C(()=>{const d=o?i.answers.join(","):i.answer;w();const g=o?i.answers.join(","):i.answer;d!==g&&h()});l.observe(a,{childList:!0,subtree:o}),n.push(l),(s?.filter(d=>d.drag_map?.length>0)||[]).forEach(d=>{const g=d.drag_map.find(T=>T.text===i.text);if(!g)return;const M=(g.answers||[g.answer]).join(", "),E=u(":scope >p",a);E&&(E.innerText=M)})})}function I(e){["sub_questions","input_answers","candidates","drag_map","img_src","options","text"].forEach(n=>{e?.[n]?.length||delete e[n]})}function y(...e){window.postMessage({source:"page-script",payload:e},"*")}async function R(e,t){const n=await D(e,t);_(n?"Saved to storage":"Failed to save to storage")}function C(e){return new MutationObserver(e)}const A=e=>e&&!e.startsWith("Kéo và thả"),f=e=>e?.innerText?.trim()||"";function S(e,t=500){let n;return(...s)=>{clearTimeout(n),n=setTimeout(()=>e(...s),t)}}async function D(e,t){if(!chrome?.storage?.local)return!1;try{return await chrome.storage.local.set({[e]:t}),!0}catch{return!1}}async function $(e){if(chrome?.storage?.local)try{return(await chrome.storage.local.get(e))[e]}catch{return null}}function j(){return{no:k(f(u("fieldset legend"))),text:Q(f(u("fieldset div"))),img_src:u("fieldset img")?.src||"",sub_questions:[],input_answers:[],candidates:[],drag_map:[],options:[]}}function G(e){const t=Q(f(u(":scope > label",e)));return{no:k(f(u(":scope > label > b",e))),text:t.replace(/^\d+\)\s*/,"")}}function O(){const e=["radio","group-radio","check-box","grouping-2","drag-drop-2","group-input"];for(const t of e){const n=u(`question-type-${t}`);if(n)return{type:t,el:n}}return{type:"unknown",el:null}}function z({el:e,question:t,restore:n}){F({el:e,question:t,restore:n,isRadio:!0})}function K({el:e,question:t,restore:n}){const s=m(".question-type-group-radio__element",e),o=n?.filter(c=>c?.type==="group-radio"&&Array.isArray(c.sub_questions)).flatMap(c=>c.sub_questions)||[];for(const c of s){const p=G(c);F({el:c,question:p,isRadio:!0,parentQuestion:t,restore:o}),t.sub_questions.push(p)}}function N({el:e,question:t,restore:n}){F({el:e,question:t,restore:n})}function W({el:e,question:t,observerManager:n,restore:s}){L(e,t,n,{restore:s,multiple:!0})}function Z({el:e,question:t,observerManager:n,restore:s}){L(e,t,n,{restore:s,multiple:!1})}function B({el:e,question:t,restore:n}){const s=m("label",e),o=m("input",e),c=S(()=>y(t));console.log(n);const v=n.find(h=>h?.text===t.text&&h?.type===t.type)?.input_answers||[];s.forEach((h,b)=>{const r=o[b],a=f(h).replace(/^\d+\)\s*/,""),i={text:a,value:r?.value||""};t.input_answers.push(i),r?.addEventListener("input",()=>{i.value=r.value,c()});const w=v.find(l=>l.text===a);w?.value&&(r.value=w.value,r.dispatchEvent(new Event("input",{bubbles:!0})))})}const H={radio:(...e)=>z(...e),"group-radio":(...e)=>K(...e),"check-box":(...e)=>N(...e),"grouping-2":(...e)=>W(...e),"drag-drop-2":(...e)=>Z(...e),"group-input":(...e)=>B(...e)};(()=>{if(!(location.hostname==="lms.ictu.edu.vn"||location.href.startsWith("file")))return;console.clear();const t={lastIndex:0,observers:[],restore:[],test:[]};window.addEventListener("message",async({source:n,data:s})=>{if(n===window&&s?.source==="page-script"){const o=s.payload[0];t.test[o.no-1]=o,await R("test",t.test)}}),setInterval(async()=>{const{type:n,el:s}=O();if(!s)return;t.restore=await $("restore");const o=j();o.no!==t.lastIndex&&(t.observers.forEach(c=>c.disconnect()),t.observers=[],o.type=n,H[n]?.({el:s,question:o,observerManager:t.observers,...t}),I(o),y(o),_(o),t.lastIndex=o.no)},1e3)})();
